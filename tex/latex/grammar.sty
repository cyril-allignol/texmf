%% Greatly inspired by the "syntax" package by Mark Wooding

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{grammar}[2018/08/21 0.1 Typesetting BNF grammars]

\RequirePackage{xparse}
\RequirePackage{xifthen}
\RequirePackage{xstring}
\RequirePackage{synttree}

% \newif\if@classic
% \@classicfalse
% \DeclareOption{classic}{\@classictrue}
% \ProcessOptions

%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand{\bnfntfont}{}{\itshape}
\NewDocumentCommand{\bnftsfont}{}{\bfseries\ttfamily}
\NewDocumentCommand{\altop}{}{\mathrel{|}}
\NewDocumentCommand{\bnfntleft}{}{}
\NewDocumentCommand{\bnfntright}{}{}
\NewDocumentCommand{\bnftsleft}{}{}
\NewDocumentCommand{\bnftsright}{}{}
\NewDocumentCommand{\productionop}{}{\mathrel{\rightarrow}}
% \if@classic
%   \RenewDocumentCommand{\bnfntleft}{}{$\langle$}
%   \RenewDocumentCommand{\bnfntright}{}{$\rangle$}
%   \RenewDocumentCommand{\bnftsleft}{}{`}
%   \RenewDocumentCommand{\bnftsright}{}{'}
%   \RenewDocumentCommand{\productionop}{}{\mathrel{\Coloneqq}}
% \fi

\NewDocumentCommand{\bnfnt}{m}{\text{\bnfntleft{\bnfntfont#1}\bnfntright}}
\NewDocumentCommand{\bnfts}{m}{\text{\bnftsleft{\bnftsfont#1}\bnftsright}}

\newboolean{numrules}\setboolean{numrules}{false}
\newboolean{inline}\setboolean{inline}{false}
\newboolean{inlinerules}\setboolean{inlinerules}{false}
\newboolean{repeatnt}\setboolean{repeatnt}{true}

\newcounter{ruleno}
\NewDocumentCommand{\rulenumber}{}{{\color{gray}\arabic{ruleno}.}}
\NewDocumentCommand{\newrule}{}{%
  \stepcounter{ruleno}%
  \item[\ifthenelse{\boolean{numrules}}{\rulenumber}{}]}

\newsavebox{\rulelabel}

\begingroup%
\catcode`< = \active%
\catcode`" = \active%
\catcode`| = \active%
\gdef\inlinerule{
  \catcode`< = \active%
  \catcode`" = \active%
  \catcode`| = \active%
  \def|={$\productionop$}%
  \def|{$\altop$}
}
\gdef\prod#1|={%
  \savebox{\rulelabel}{$#1 \productionop$}%
  \ifthenelse{\boolean{inline}}%
  {\usebox{\rulelabel}}%
  {\newrule\usebox{\rulelabel}}}%
\gdef|{%
  \ifthenelse{\boolean{inlinerules}}%
  {$\altop$}%
  {\ifthenelse{\boolean{repeatnt}}%
    {\newrule\usebox{\rulelabel}}%
    {\newrule\makebox[\wd\rulelabel][r]{$\altop$}}}}%
\gdef<#1>{\bnfnt{#1}}%
\gdef"#1"{\bnfts{#1}}%
\endgroup%
\NewDocumentCommand{\activategrammar}{}{%
  \catcode`< = \active%
  \catcode`" = \active%
  \catcode`| = \active%
}

\NewDocumentEnvironment{inlinegrammar}{}
{\setboolean{inline}{true}\setboolean{inlinerules}{true}\activategrammar}{}

% \NewDocumentCommand{\inlinerule}{m}{%
%   \setboolean{inline}{true}\setboolean{inlinerules}{true}\activategrammar%
%   #1}
\NewDocumentCommand{\lritem}{m}{%
  \setboolean{inline}{true}\setboolean{inlinerules}{true}\activategrammar%
  #1}

\NewDocumentEnvironment{grammar}{so}{%
  \IfValueT{#2}{%
    \IfStrEq{#2}{inlinerules}{\setboolean{inlinerules}{true}}{}%
  }
  \setcounter{ruleno}{0}%
  \setboolean{numrules}{\IfBooleanTF{#1}{false}{true}}%
  \par\activategrammar%
  \list{}{%
    \setlength{\labelwidth}{\IfBooleanTF{#1}{\z@}{1em}}
    \setlength{\labelsep}{\IfBooleanTF{#1}{\z@}{0.4em}}
    \setlength{\leftmargin}{\dimexpr \labelwidth + \labelsep}
    \setlength{\itemindent}{\z@}
    \setlength{\listparindent}{\z@}
    \setlength{\parsep}{\z@}
    \setlength{\itemsep}{\z@}
  }
}{\endlist\par\relax\setboolean{inlinerules}{false}}

%% Place the star at a more intuitive position
\ExplSyntaxOn
\cs_new:cpn {grammar*} {\grammar*}
\cs_new_eq:cN {endgrammar*} \endgrammar
\ExplSyntaxOff

\endinput
